# 実装計画: Face-Auth IdP System

## 概要

AWS ベースの Face-Auth IdP システムの実装計画です。この計画は、社員証ベースの信頼チェーンと顔認識によるパスワードレス認証システムを段階的に構築します。実装はインフラ設定から始まり、コア認証ロジック、データ管理、そしてフロントエンド統合まで段階的に進めます。

## タスクリスト

- [x] 1. AWS インフラおよび基本設定構築
  - AWS CDK を使用して VPC、Direct Connect、セキュリティグループ設定
  - S3 バケット、DynamoDB テーブル、Lambda 関数基本構造作成
  - IAM ロールおよびポリシー構成
  - _要件: 4.1, 4.4, 4.5, 4.7_

- [ ]* 1.1 インフラコンポーネントプロパティテスト作成
  - **プロパティ 13: データ暗号化適用**
  - **検証対象: 要件 4.6, 5.6**

- [x] 2. データモデルおよびコアサービス実装
  - [x] 2.1 DynamoDB テーブルスキーマおよびデータモデル実装
    - CardTemplates, EmployeeFaces テーブル作成
    - データモデルクラス (EmployeeInfo, FaceData, AuthenticationSession) 実装
    - _要件: 5.5, 7.4_

  - [ ]* 2.2 カードテンプレートデータ構造プロパティテスト作成
    - **プロパティ 15: カードテンプレートデータ構造**
    - **検証対象: 要件 7.4**

  - [x] 2.3 画像処理サービス実装 (ThumbnailProcessor)
    - 200x200 サムネイル生成ロジック
    - 元画像削除および S3 保存機能
    - _要件: 5.1, 5.2_

  - [ ]* 2.4 サムネイル処理一貫性プロパティテスト作成
    - **プロパティ 9: サムネイル処理の一貫性**
    - **検証対象: 要件 1.5, 5.1**

- [x] 3. Amazon Textract OCR エンジン実装
  - [x] 3.1 OCRService クラス実装
    - カードテンプレートベースの動的 Textract Query 構成
    - 社員情報抽出および検証ロジック
    - _要件: 1.2, 7.1, 7.2, 7.6_

  - [ ]* 3.2 OCR エンジン使用一貫性プロパティテスト作成
    - **プロパティ 1: OCR エンジン使用の一貫性**
    - **検証対象: 要件 1.1, 3.2, 7.1, 9.1**

  - [ ]* 3.3 カードテンプレートベース処理プロパティテスト作成
    - **プロパティ 2: カードテンプレートベース処理**
    - **検証対象: 要件 1.2, 7.2**

  - [ ]* 3.4 動的クエリ構成プロパティテスト作成
    - **プロパティ 16: 動的クエリ構成**
    - **検証対象: 要件 7.6**

- [ ] 4. Active Directory 接続サービス完成
  - [x] 4.1 ADConnector クラス完成
    - ldap3 ライブラリ統合および接続ロジック実装
    - 社員情報検証メソッド完成
    - パスワード認証メソッド完成
    - 10秒タイムアウト制限実装およびテスト
    - _要件: 1.3, 3.4, 4.2_

  - [ ]* 4.2 AD 接続タイムアウト遵守プロパティテスト作成
    - **プロパティ 3: AD 接続タイムアウト遵守**
    - **検証対象: 要件 1.3, 3.4, 4.2**

- [ ] 5. Amazon Rekognition 顔認識サービス実装
  - [x] 5.1 FaceRecognitionService クラス実装
    - Rekognition コレクション作成および管理
    - Liveness Detection (信頼度 > 90%) 機能
    - 1:N 顔検索およびマッチングロジック
    - 顔登録 (IndexFaces) および削除機能
    - _要件: 2.1, 2.2, 6.1, 6.2, 6.4_

  - [ ]* 5.2 Liveness Detection 必須使用プロパティテスト作成
    - **プロパティ 4: Liveness Detection 必須使用**
    - **検証対象: 要件 2.1, 6.1, 6.2**

  - [ ]* 5.3 1:N 顔マッチング実行プロパティテスト作成
    - **プロパティ 5: 1:N 顔マッチング実行**
    - **検証対象: 要件 2.2, 6.4**

- [ ] 6. エラー処理およびタイムアウト管理実装
  - [x] 6.1 ErrorHandler クラス実装
    - 具体的エラーメッセージ (社員証規格不一致、登録情報不一致、アカウント無効化)
    - 一般的エラーメッセージ ("明るい場所で再度お試しください")
    - system_reason と user_message 分離
    - _要件: 1.6, 1.7, 1.8, 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_

  - [ ]* 6.2 具体的エラーメッセージ返却プロパティテスト作成
    - **プロパティ 10: 具体的エラーメッセージ返却**
    - **検証対象: 要件 1.6, 1.7, 1.8, 8.2, 8.3, 8.4**

  - [ ]* 6.3 一般的エラーメッセージ表示プロパティテスト作成
    - **プロパティ 11: 一般的エラーメッセージ表示**
    - **検証対象: 要件 2.7, 3.7, 8.5**

  - [ ]* 6.4 エラーレスポンス構造分離プロパティテスト作成
    - **プロパティ 18: エラーレスポンス構造分離**
    - **検証対象: 要件 8.6**

  - [x] 6.5 TimeoutManager クラス実装
    - Lambda 15秒タイムアウト管理
    - AD 10秒タイムアウト管理
    - 残り時間追跡および早期終了ロジック
    - _要件: 4.2, 4.3_

  - [ ]* 6.6 Lambda タイムアウト遵守プロパティテスト作成
    - **プロパティ 12: Lambda タイムアウト遵守**
    - **検証対象: 要件 4.3**

- [ ] 7. チェックポイント - コアサービス検証
  - すべてのコアサービス (OCR, AD, Rekognition, エラー処理) テスト通過確認
  - 統合テスト実行および問題解決

- [x] 8. 認証フロー Lambda 関数実装
  - [x] 8.1 社員登録 Lambda 関数 (handle_enrollment) 完成
    - 社員証 OCR → AD 検証 → 顔キャプチャ → サムネイル保存フロー実装
    - OCRService, ADConnector, FaceRecognitionService, ThumbnailProcessor 統合
    - DynamoDB に EmployeeFaceRecord 保存
    - エラー処理およびレスポンス生成
    - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

  - [ ]* 8.2 登録フロー統合プロパティテスト作成
    - 複数のプロパティを組み合わせた統合テスト
    - **検証対象: 要件 1.1-1.8**

  - [x] 8.3 顔ログイン Lambda 関数 (handle_face_login) 完成
    - 顔 Liveness 検証 → 1:N マッチング → セッション作成フロー実装
    - FaceRecognitionService と Cognito 統合
    - 失敗時ログイン試行画像保存 (ThumbnailProcessor)
    - DynamoDB last_login 更新
    - _要件: 2.1, 2.2, 2.3, 2.4_

  - [ ]* 8.4 認証セッション作成プロパティテスト作成
    - **プロパティ 6: 認証セッション作成**
    - **検証対象: 要件 2.3, 3.5**

  - [ ]* 8.5 失敗したログイン試行保存プロパティテスト作成
    - **プロパティ 7: 失敗したログイン試行の保存**
    - **検証対象: 要件 2.4, 5.3**

  - [x] 8.6 緊急認証 Lambda 関数 (handle_emergency_auth) 完成
    - 社員証 OCR → AD パスワード検証 → セッション作成フロー実装
    - OCRService, ADConnector, Cognito 統合
    - レート制限実装 (DynamoDB を使用した試行回数追跡)
    - _要件: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_

  - [ ]* 8.7 緊急ログインオプション提供プロパティテスト作成
    - **プロパティ 8: 緊急ログインオプション提供**
    - **検証対象: 要件 2.6, 3.1**

  - [ ]* 8.8 レート制限実装プロパティテスト作成
    - **プロパティ 24: レート制限実装**
    - **検証対象: 要件 3.6, 6.6**

- [x] 9. 再登録およびデータ管理機能実装
  - [x] 9.1 再登録 Lambda 関数 (handle_re_enrollment) 完成
    - 本人確認 (OCR + AD) → 新しい顔キャプチャ → 既存データ置換
    - 既存 Rekognition face 削除および新 face 登録
    - DynamoDB EmployeeFaceRecord 更新 (re_enrollment_count 増加)
    - 監査追跡記録 (CloudWatch Logs)
    - _要件: 9.1, 9.2, 9.3, 9.4, 9.5_

  - [ ]* 9.2 再登録データ置換プロパティテスト作成
    - **プロパティ 20: 再登録データ置換**
    - **検証対象: 要件 9.3, 9.5**

  - [ ]* 9.3 再登録失敗時データ保存プロパティテスト作成
    - **プロパティ 21: 再登録失敗時のデータ保存**
    - **検証対象: 要件 9.6**

  - [x] 9.2 ステータス確認 Lambda 関数 (handle_status) 完成
    - セッション有効性検証
    - Cognito トークン検証
    - 認証ステータス返却
    - _要件: 2.5, 10.7_

  - [ ]* 9.3 アクセス制御および監査ログプロパティテスト作成
    - **プロパティ 14: アクセス制御および監査ログ**
    - **検証対象: 要件 5.7, 6.7**

- [x] 10. AWS Cognito 統合およびセッション管理
  - [x] 10.1 Cognito ユーザー作成およびトークン発行ロジック実装
    - AdminCreateUser および AdminInitiateAuth 使用
    - JWT トークン生成および検証
    - セッション有効期限処理
    - _要件: 2.3, 3.5_

  - [x] 10.2 AuthenticationSession DynamoDB 管理実装
    - セッション作成、検証、削除ロジック
    - TTL を使用した自動有効期限
    - _要件: 2.5, 10.7_

  - [ ]* 10.3 成功した認証後リダイレクトプロパティテスト作成
    - **プロパティ 23: 成功した認証後のリダイレクト**
    - **検証対象: 要件 10.7**

- [x] 11. チェックポイント - バックエンドシステム統合検証
  - すべての Lambda 関数ユニットテスト通過確認
  - エンドツーエンド認証フローテスト (登録 → ログイン → 再登録)
  - 緊急認証フローテスト
  - エラー処理シナリオテスト

- [~] 12. React フロントエンド実装
  - [~] 12.1 基本 React アプリおよび AWS Amplify 設定
    - Create React App または Next.js プロジェクト作成
    - AWS Amplify UI ライブラリインストールおよび構成
    - API Gateway エンドポイント接続設定
    - _要件: 10.1_

  - [~] 12.2 AuthenticationComponent 実装
    - LOGIN, ENROLL, ID_SCAN, EMERGENCY モードサポート
    - FaceLivenessDetector 統合
    - カメラアクセスおよび画像キャプチャ
    - エラーメッセージ表示および処理
    - _要件: 10.2, 10.3, 10.5_

  - [ ]* 12.3 UI モードサポートプロパティテスト作成
    - **プロパティ 22: UI モードサポート**
    - **検証対象: 要件 10.3**

  - [~] 12.4 API クライアントサービス実装
    - Lambda 関数との通信ロジック
    - リクエスト/レスポンス処理およびエラーハンドリング
    - 画像アップロードおよび Base64 エンコーディング
    - _要件: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7_

  - [~] 12.5 認証状態管理およびルーティング
    - React Context または Redux を使用した状態管理
    - 保護されたルート実装
    - セッション有効期限処理
    - _要件: 2.5, 10.7_

- [~] 13. 統合テストおよびエンドツーエンドテスト
  - [~] 13.1 完全な認証フロー統合テスト
    - 登録 → ログイン → 再登録完全シナリオ
    - 緊急認証フローテスト
    - エラー回復シナリオテスト
    - _要件: 1.1-10.7_

  - [ ]* 13.2 詳細エラーログプロパティテスト作成
    - **プロパティ 19: 詳細エラーログ**
    - **検証対象: 要件 8.7**

  - [~] 13.3 パフォーマンスおよび負荷テスト
    - 同時ユーザー処理能力テスト
    - AWS サービス制限およびタイムアウトテスト
    - メモリ使用量および Lambda コールドスタート最適化
    - _要件: 4.2, 4.3, 6.5_

- [~] 14. S3 Lifecycle ポリシー検証およびデータ管理
  - [~] 14.1 S3 Lifecycle ポリシー動作検証
    - logins/ フォルダ 30日自動削除確認
    - temp/ フォルダ 1日自動削除確認
    - enroll/ フォルダ永久保管確認
    - _要件: 5.2, 5.3, 5.4, 5.6_

  - [~] 14.2 カードテンプレートランタイム更新機能テスト
    - DynamoDB からテンプレート動的ロード確認
    - 新規テンプレート追加時再起動なしで適用確認
    - _要件: 7.7_

  - [ ]* 14.3 ランタイムテンプレート更新プロパティテスト作成
    - **プロパティ 17: ランタイムテンプレート更新**
    - **検証対象: 要件 7.7**

- [~] 15. デプロイおよびモニタリング設定
  - [~] 15.1 AWS CDK デプロイスクリプト完成およびデプロイ
    - プロダクション環境構成検証
    - 環境別設定管理 (dev, staging, prod)
    - デプロイ自動化スクリプト作成
    - _要件: 4.4_

  - [~] 15.2 CloudWatch ログおよびモニタリング設定
    - Lambda 関数ログ収集確認
    - パフォーマンスメトリクスおよびアラーム設定
    - ダッシュボード作成 (認証成功率、エラー率、応答時間)
    - _要件: 6.7, 8.7_

  - [~] 15.3 セキュリティレビューおよび脆弱性スキャン
    - IAM 権限最小化検証
    - 暗号化設定確認 (S3, DynamoDB, 転送中)
    - API Gateway セキュリティ設定検証
    - _要件: 4.6, 4.7, 5.6_

- [~] 16. 最終チェックポイント - 全体システム検証
  - すべてのユニットテストおよび統合テスト通過確認
  - プロダクション環境デプロイおよびスモークテスト
  - ドキュメント化完了 (API ドキュメント、運用ガイド、トラブルシューティングガイド)
  - ユーザー受け入れテスト (UAT) 準備

## 参考事項

- `*`で表示されたタスクはオプションで、迅速な MVP のためにスキップ可能です
- 各タスクは特定の要件を参照してトレーサビリティを保証します
- チェックポイントは段階的検証を通じて問題を早期に発見します
- プロパティテストは汎用正確性プロパティを検証します
- ユニットテストは具体的な例とエッジケースを検証します

## 現在の実装状況サマリー

### 完了したタスク
- ✅ AWS インフラ (VPC, S3, DynamoDB, Lambda 基本構造, IAM, API Gateway, Cognito)
- ✅ データモデル (EmployeeInfo, FaceData, AuthenticationSession, CardTemplate)
- ✅ DynamoDB サービス (CRUD 操作、インデックスクエリ)
- ✅ ThumbnailProcessor (200x200 サムネイル生成、S3 保存、元画像削除)
- ✅ OCRService (Textract 統合、動的クエリ構成、テンプレートベース抽出)
- ✅ ユニットテスト (データモデル、ThumbnailProcessor、OCRService、インフラ)

### 進行中のタスク
- 🔄 ADConnector (基本構造作成済み、ldap3 統合必要)

### 次のステップ
1. ADConnector 完成 (ldap3 統合およびテスト)
2. FaceRecognitionService 実装 (Rekognition 統合)
3. ErrorHandler および TimeoutManager 実装
4. Lambda 関数ハンドラー完成 (enrollment, face_login, emergency_auth, re_enrollment, status)
5. Cognito 統合およびセッション管理
6. React フロントエンド実装
7. 統合テストおよびデプロイ