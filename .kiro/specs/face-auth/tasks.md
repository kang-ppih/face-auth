# 구현 계획: Face-Auth IdP System

## 개요

AWS 기반 Face-Auth IdP 시스템의 구현 계획입니다. 이 계획은 사원증 기반 신뢰 체인과 얼굴 인식을 통한 무패스워드 인증 시스템을 단계별로 구축합니다. 구현은 인프라 설정부터 시작하여 핵심 인증 로직, 데이터 관리, 그리고 프론트엔드 통합까지 점진적으로 진행됩니다.

## 작업 목록

- [x] 1. AWS 인프라 및 기본 설정 구축
  - AWS CDK를 사용하여 VPC, Direct Connect, 보안 그룹 설정
  - S3 버킷, DynamoDB 테이블, Lambda 함수 기본 구조 생성
  - IAM 역할 및 정책 구성
  - _요구사항: 4.1, 4.4, 4.5, 4.7_

- [ ]* 1.1 인프라 구성 요소 속성 테스트 작성
  - **속성 13: 데이터 암호화 적용**
  - **검증 대상: 요구사항 4.6, 5.6**

- [x] 2. 데이터 모델 및 핵심 서비스 구현
  - [x] 2.1 DynamoDB 테이블 스키마 및 데이터 모델 구현
    - CardTemplates, EmployeeFaces 테이블 생성
    - 데이터 모델 클래스 (EmployeeInfo, FaceData, AuthenticationSession) 구현
    - _요구사항: 5.5, 7.4_

  - [ ]* 2.2 카드 템플릿 데이터 구조 속성 테스트 작성
    - **속성 15: 카드 템플릿 데이터 구조**
    - **검증 대상: 요구사항 7.4**

  - [x] 2.3 이미지 처리 서비스 구현 (ThumbnailProcessor)
    - 200x200 썸네일 생성 로직
    - 원본 이미지 삭제 및 S3 저장 기능
    - _요구사항: 5.1, 5.2_

  - [ ]* 2.4 썸네일 처리 일관성 속성 테스트 작성
    - **속성 9: 썸네일 처리 일관성**
    - **검증 대상: 요구사항 1.5, 5.1**

- [x] 3. Amazon Textract OCR 엔진 구현
  - [x] 3.1 OCRService 클래스 구현
    - 카드 템플릿 기반 동적 Textract Query 구성
    - 직원 정보 추출 및 검증 로직
    - _요구사항: 1.2, 7.1, 7.2, 7.6_

  - [ ]* 3.2 OCR 엔진 사용 일관성 속성 테스트 작성
    - **속성 1: OCR 엔진 사용 일관성**
    - **검증 대상: 요구사항 1.1, 3.2, 7.1, 9.1**

  - [ ]* 3.3 카드 템플릿 기반 처리 속성 테스트 작성
    - **속성 2: 카드 템플릿 기반 처리**
    - **검증 대상: 요구사항 1.2, 7.2**

  - [ ]* 3.4 동적 쿼리 구성 속성 테스트 작성
    - **속성 16: 동적 쿼리 구성**
    - **검증 대상: 요구사항 7.6**

- [ ] 4. Active Directory 연결 서비스 완성
  - [x] 4.1 ADConnector 클래스 완성
    - ldap3 라이브러리 통합 및 연결 로직 구현
    - 직원 정보 검증 메서드 완성
    - 비밀번호 인증 메서드 완성
    - 10초 타임아웃 제한 구현 및 테스트
    - _요구사항: 1.3, 3.4, 4.2_

  - [ ]* 4.2 AD 연결 타임아웃 준수 속성 테스트 작성
    - **속성 3: AD 연결 타임아웃 준수**
    - **검증 대상: 요구사항 1.3, 3.4, 4.2**

- [ ] 5. Amazon Rekognition 얼굴 인식 서비스 구현
  - [x] 5.1 FaceRecognitionService 클래스 구현
    - Rekognition 컬렉션 생성 및 관리
    - Liveness Detection (신뢰도 > 90%) 기능
    - 1:N 얼굴 검색 및 매칭 로직
    - 얼굴 등록 (IndexFaces) 및 삭제 기능
    - _요구사항: 2.1, 2.2, 6.1, 6.2, 6.4_

  - [ ]* 5.2 Liveness Detection 필수 사용 속성 테스트 작성
    - **속성 4: Liveness Detection 필수 사용**
    - **검증 대상: 요구사항 2.1, 6.1, 6.2**

  - [ ]* 5.3 1:N 얼굴 매칭 수행 속성 테스트 작성
    - **속성 5: 1:N 얼굴 매칭 수행**
    - **검증 대상: 요구사항 2.2, 6.4**

- [ ] 6. 오류 처리 및 타임아웃 관리 구현
  - [x] 6.1 ErrorHandler 클래스 구현
    - 구체적 오류 메시지 (사원증 규격 불일치, 등록 정보 불일치, 계정 비활성화)
    - 일반적 오류 메시지 ("밝은 곳에서 다시 시도해주세요")
    - system_reason과 user_message 분리
    - _요구사항: 1.6, 1.7, 1.8, 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_

  - [ ]* 6.2 구체적 오류 메시지 반환 속성 테스트 작성
    - **속성 10: 구체적 오류 메시지 반환**
    - **검증 대상: 요구사항 1.6, 1.7, 1.8, 8.2, 8.3, 8.4**

  - [ ]* 6.3 일반적 오류 메시지 표시 속성 테스트 작성
    - **속성 11: 일반적 오류 메시지 표시**
    - **검증 대상: 요구사항 2.7, 3.7, 8.5**

  - [ ]* 6.4 오류 응답 구조 분리 속성 테스트 작성
    - **속성 18: 오류 응답 구조 분리**
    - **검증 대상: 요구사항 8.6**

  - [x] 6.5 TimeoutManager 클래스 구현
    - Lambda 15초 타임아웃 관리
    - AD 10초 타임아웃 관리
    - 남은 시간 추적 및 조기 종료 로직
    - _요구사항: 4.2, 4.3_

  - [ ]* 6.6 Lambda 타임아웃 준수 속성 테스트 작성
    - **속성 12: Lambda 타임아웃 준수**
    - **검증 대상: 요구사항 4.3**

- [ ] 7. 체크포인트 - 핵심 서비스 검증
  - 모든 핵심 서비스 (OCR, AD, Rekognition, 오류 처리) 테스트 통과 확인
  - 통합 테스트 실행 및 문제 해결

- [x] 8. 인증 흐름 Lambda 함수 구현
  - [x] 8.1 직원 등록 Lambda 함수 (handle_enrollment) 완성
    - 사원증 OCR → AD 검증 → 얼굴 캡처 → 썸네일 저장 흐름 구현
    - OCRService, ADConnector, FaceRecognitionService, ThumbnailProcessor 통합
    - DynamoDB에 EmployeeFaceRecord 저장
    - 오류 처리 및 응답 생성
    - _요구사항: 1.1, 1.2, 1.3, 1.4, 1.5_

  - [ ]* 8.2 등록 흐름 통합 속성 테스트 작성
    - 여러 속성을 조합한 통합 테스트
    - **검증 대상: 요구사항 1.1-1.8**

  - [x] 8.3 얼굴 로그인 Lambda 함수 (handle_face_login) 완성
    - 얼굴 Liveness 검증 → 1:N 매칭 → 세션 생성 흐름 구현
    - FaceRecognitionService와 Cognito 통합
    - 실패 시 로그인 시도 이미지 저장 (ThumbnailProcessor)
    - DynamoDB last_login 업데이트
    - _요구사항: 2.1, 2.2, 2.3, 2.4_

  - [ ]* 8.4 인증 세션 생성 속성 테스트 작성
    - **속성 6: 인증 세션 생성**
    - **검증 대상: 요구사항 2.3, 3.5**

  - [ ]* 8.5 실패한 로그인 시도 저장 속성 테스트 작성
    - **속성 7: 실패한 로그인 시도 저장**
    - **검증 대상: 요구사항 2.4, 5.3**

  - [x] 8.6 비상 인증 Lambda 함수 (handle_emergency_auth) 완성
    - 사원증 OCR → AD 비밀번호 검증 → 세션 생성 흐름 구현
    - OCRService, ADConnector, Cognito 통합
    - 속도 제한 구현 (DynamoDB를 사용한 시도 횟수 추적)
    - _요구사항: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_

  - [ ]* 8.7 비상 로그인 옵션 제공 속성 테스트 작성
    - **속성 8: 비상 로그인 옵션 제공**
    - **검증 대상: 요구사항 2.6, 3.1**

  - [ ]* 8.8 속도 제한 구현 속성 테스트 작성
    - **속성 24: 속도 제한 구현**
    - **검증 대상: 요구사항 3.6, 6.6**

- [x] 9. 재등록 및 데이터 관리 기능 구현
  - [x] 9.1 재등록 Lambda 함수 (handle_re_enrollment) 완성
    - 신원 확인 (OCR + AD) → 새 얼굴 캡처 → 기존 데이터 교체
    - 기존 Rekognition face 삭제 및 새 face 등록
    - DynamoDB EmployeeFaceRecord 업데이트 (re_enrollment_count 증가)
    - 감사 추적 기록 (CloudWatch Logs)
    - _요구사항: 9.1, 9.2, 9.3, 9.4, 9.5_

  - [ ]* 9.2 재등록 데이터 교체 속성 테스트 작성
    - **속성 20: 재등록 데이터 교체**
    - **검증 대상: 요구사항 9.3, 9.5**

  - [ ]* 9.3 재등록 실패 시 데이터 보존 속성 테스트 작성
    - **속성 21: 재등록 실패 시 데이터 보존**
    - **검증 대상: 요구사항 9.6**

  - [x] 9.2 상태 확인 Lambda 함수 (handle_status) 완성
    - 세션 유효성 검증
    - Cognito 토큰 검증
    - 인증 상태 반환
    - _요구사항: 2.5, 10.7_

  - [ ]* 9.3 접근 제어 및 감사 로깅 속성 테스트 작성
    - **속성 14: 접근 제어 및 감사 로깅**
    - **검증 대상: 요구사항 5.7, 6.7**

- [x] 10. AWS Cognito 통합 및 세션 관리
  - [x] 10.1 Cognito 사용자 생성 및 토큰 발급 로직 구현
    - AdminCreateUser 및 AdminInitiateAuth 사용
    - JWT 토큰 생성 및 검증
    - 세션 만료 처리
    - _요구사항: 2.3, 3.5_

  - [x] 10.2 AuthenticationSession DynamoDB 관리 구현
    - 세션 생성, 검증, 삭제 로직
    - TTL을 사용한 자동 만료
    - _요구사항: 2.5, 10.7_

  - [ ]* 10.3 성공적 인증 후 리디렉션 속성 테스트 작성
    - **속성 23: 성공적 인증 후 리디렉션**
    - **검증 대상: 요구사항 10.7**

- [x] 11. 체크포인트 - 백엔드 시스템 통합 검증
  - 모든 Lambda 함수 단위 테스트 통과 확인
  - 엔드투엔드 인증 흐름 테스트 (등록 → 로그인 → 재등록)
  - 비상 인증 흐름 테스트
  - 오류 처리 시나리오 테스트

- [~] 12. React 프론트엔드 구현
  - [~] 12.1 기본 React 앱 및 AWS Amplify 설정
    - Create React App 또는 Next.js 프로젝트 생성
    - AWS Amplify UI 라이브러리 설치 및 구성
    - API Gateway 엔드포인트 연결 설정
    - _요구사항: 10.1_

  - [~] 12.2 AuthenticationComponent 구현
    - LOGIN, ENROLL, ID_SCAN, EMERGENCY 모드 지원
    - FaceLivenessDetector 통합
    - 카메라 접근 및 이미지 캡처
    - 오류 메시지 표시 및 처리
    - _요구사항: 10.2, 10.3, 10.5_

  - [ ]* 12.3 UI 모드 지원 속성 테스트 작성
    - **속성 22: UI 모드 지원**
    - **검증 대상: 요구사항 10.3**

  - [~] 12.4 API 클라이언트 서비스 구현
    - Lambda 함수와의 통신 로직
    - 요청/응답 처리 및 오류 핸들링
    - 이미지 업로드 및 Base64 인코딩
    - _요구사항: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7_

  - [~] 12.5 인증 상태 관리 및 라우팅
    - React Context 또는 Redux를 사용한 상태 관리
    - 보호된 라우트 구현
    - 세션 만료 처리
    - _요구사항: 2.5, 10.7_

- [~] 13. 통합 테스트 및 엔드투엔드 테스트
  - [~] 13.1 전체 인증 흐름 통합 테스트
    - 등록 → 로그인 → 재등록 전체 시나리오
    - 비상 인증 흐름 테스트
    - 오류 복구 시나리오 테스트
    - _요구사항: 1.1-10.7_

  - [ ]* 13.2 상세 오류 로깅 속성 테스트 작성
    - **속성 19: 상세 오류 로깅**
    - **검증 대상: 요구사항 8.7**

  - [~] 13.3 성능 및 부하 테스트
    - 동시 사용자 처리 능력 테스트
    - AWS 서비스 제한 및 타임아웃 테스트
    - 메모리 사용량 및 Lambda 콜드 스타트 최적화
    - _요구사항: 4.2, 4.3, 6.5_

- [~] 14. S3 Lifecycle 정책 검증 및 데이터 관리
  - [~] 14.1 S3 Lifecycle 정책 동작 검증
    - logins/ 폴더 30일 자동 삭제 확인
    - temp/ 폴더 1일 자동 삭제 확인
    - enroll/ 폴더 영구 보관 확인
    - _요구사항: 5.2, 5.3, 5.4, 5.6_

  - [~] 14.2 카드 템플릿 런타임 업데이트 기능 테스트
    - DynamoDB에서 템플릿 동적 로딩 확인
    - 새 템플릿 추가 시 재시작 없이 적용 확인
    - _요구사항: 7.7_

  - [ ]* 14.3 런타임 템플릿 업데이트 속성 테스트 작성
    - **속성 17: 런타임 템플릿 업데이트**
    - **검증 대상: 요구사항 7.7**

- [~] 15. 배포 및 모니터링 설정
  - [~] 15.1 AWS CDK 배포 스크립트 완성 및 배포
    - 프로덕션 환경 구성 검증
    - 환경별 설정 관리 (dev, staging, prod)
    - 배포 자동화 스크립트 작성
    - _요구사항: 4.4_

  - [~] 15.2 CloudWatch 로깅 및 모니터링 설정
    - Lambda 함수 로그 수집 확인
    - 성능 메트릭 및 알람 설정
    - 대시보드 생성 (인증 성공률, 오류율, 응답 시간)
    - _요구사항: 6.7, 8.7_

  - [~] 15.3 보안 검토 및 취약점 스캔
    - IAM 권한 최소화 검증
    - 암호화 설정 확인 (S3, DynamoDB, 전송 중)
    - API Gateway 보안 설정 검증
    - _요구사항: 4.6, 4.7, 5.6_

- [~] 16. 최종 체크포인트 - 전체 시스템 검증
  - 모든 단위 테스트 및 통합 테스트 통과 확인
  - 프로덕션 환경 배포 및 스모크 테스트
  - 문서화 완료 (API 문서, 운영 가이드, 트러블슈팅 가이드)
  - 사용자 수용 테스트 (UAT) 준비

## 참고사항

- `*`로 표시된 작업은 선택사항으로, 빠른 MVP를 위해 건너뛸 수 있습니다
- 각 작업은 특정 요구사항을 참조하여 추적 가능성을 보장합니다
- 체크포인트는 점진적 검증을 통해 문제를 조기에 발견합니다
- 속성 테스트는 범용 정확성 속성을 검증합니다
- 단위 테스트는 구체적인 예제와 엣지 케이스를 검증합니다

## 현재 구현 상태 요약

### 완료된 작업
- ✅ AWS 인프라 (VPC, S3, DynamoDB, Lambda 기본 구조, IAM, API Gateway, Cognito)
- ✅ 데이터 모델 (EmployeeInfo, FaceData, AuthenticationSession, CardTemplate)
- ✅ DynamoDB 서비스 (CRUD 작업, 인덱스 쿼리)
- ✅ ThumbnailProcessor (200x200 썸네일 생성, S3 저장, 원본 삭제)
- ✅ OCRService (Textract 통합, 동적 쿼리 구성, 템플릿 기반 추출)
- ✅ 단위 테스트 (데이터 모델, ThumbnailProcessor, OCRService, 인프라)

### 진행 중인 작업
- 🔄 ADConnector (기본 구조 작성됨, ldap3 통합 필요)

### 다음 단계
1. ADConnector 완성 (ldap3 통합 및 테스트)
2. FaceRecognitionService 구현 (Rekognition 통합)
3. ErrorHandler 및 TimeoutManager 구현
4. Lambda 함수 핸들러 완성 (enrollment, face_login, emergency_auth, re_enrollment, status)
5. Cognito 통합 및 세션 관리
6. React 프론트엔드 구현
7. 통합 테스트 및 배포