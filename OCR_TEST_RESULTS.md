# OCR単体テスト結果

## 実行日時
2026-01-28

## テスト概要
サンプル社員証画像（`sample/社員証サンプル.png`）を使用してOCR処理をテストしました。

## サンプル画像情報

### ファイル情報
- **パス**: `sample/社員証サンプル.png`
- **ファイルサイズ**: 414,072 bytes (404.37 KB)
- **画像形式**: PNG
- **画像モード**: RGBA（透明度あり）
- **画像サイズ**: 800 x 600 pixels
- **DPI**: 95.99

### 画像品質
- ✅ ファイルサイズ: 適切（400KB程度）
- ✅ 解像度: 適切（800x600）
- ✅ 形式: PNG（Textractサポート）

## テスト実行結果

### ローカル環境からのTextract接続
❌ **失敗**: ネットワーク接続エラー
```
Could not connect to the endpoint URL: "https://textract.ap-northeast-1.amazonaws.com/"
```

**原因**: 
- ローカル環境からAWS Textractへの接続が制限されている可能性
- プロキシ設定が必要な可能性
- VPN接続が必要な可能性

### Lambda環境からのTextract接続
⚠️ **タイムアウト**: 30秒でタイムアウト

**CloudWatch Logsから**:
- Textract処理開始: 成功
- 処理時間: 約29秒
- 結果: タイムアウト（データ抽出前）

## 問題の診断

### 最も可能性が高い原因
**サンプル画像に実際の社員証情報が含まれていない**

Textractが以下の情報を見つけられない場合、タイムアウトまで処理を続けます：
1. 社員番号（7桁の数字）
2. 氏名（日本語）
3. 所属/部署

### 確認が必要な項目

画像を開いて、以下を確認してください：

#### 1. 社員番号
- [ ] 「社員番号」というラベルが画像に含まれているか
- [ ] 7桁の数字が記載されているか
- [ ] 数字が読み取り可能な品質か

#### 2. 氏名
- [ ] 「氏名」というラベルが画像に含まれているか
- [ ] 日本語の名前が記載されているか
- [ ] 文字が読み取り可能な品質か

#### 3. 所属
- [ ] 「所属」または「部署」というラベルが画像に含まれているか
- [ ] 部署名が記載されているか

## 推奨される対応

### オプション1: 実際の社員証画像を使用
テスト用の実際の社員証画像を用意する：
- 社員番号: 1234567（7桁）
- 氏名: 山田太郎
- 所属: 開発部

### オプション2: テスト用画像を作成
PowerPointやPhotoshopで簡単な社員証画像を作成：
```
┌─────────────────────────┐
│  株式会社サンプル        │
│                         │
│  社員番号: 1234567      │
│  氏名: 山田太郎         │
│  所属: 開発部           │
│                         │
│  [顔写真エリア]         │
└─────────────────────────┘
```

### オプション3: OCR処理をスキップしてテスト
開発環境でOCR処理をスキップし、ハードコードされたデータでテスト：
```python
# 環境変数で制御
SKIP_OCR_FOR_TEST=true

# Lambda関数内
if os.environ.get('SKIP_OCR_FOR_TEST') == 'true':
    employee_info = EmployeeInfo(
        employee_id='1234567',
        name='山田太郎',
        department='開発部'
    )
```

### オプション4: Textract Queriesを変更
より一般的なクエリに変更：
```python
queries = [
    {'Text': '番号', 'Alias': 'employee_id'},
    {'Text': '名前', 'Alias': 'employee_name'},
    {'Text': '部署', 'Alias': 'department'}
]
```

## 次のステップ

### 即座に実行可能
1. **画像内容の確認**
   - `sample/社員証サンプル.png`を開いて内容を確認
   - 上記の確認項目をチェック

2. **画像の準備**
   - 情報が含まれていない場合、新しい画像を作成
   - または実際の社員証画像（テスト用）を用意

### 画像準備後
1. **CardTemplateの再登録**
   ```bash
   $env:AWS_PROFILE='dev'
   python scripts/register_card_template.py --register
   ```

2. **エンドツーエンドテスト再実行**
   ```bash
   python scripts/test_end_to_end_enrollment.py
   ```

## 代替テスト方法

### VPC内からのテスト
Lambda関数経由でTextractをテストする方が確実です：
1. API経由でテスト（既に実施済み）
2. Lambda関数のログでTextractレスポンスを確認

### CloudWatch Logsの詳細確認
```bash
aws logs tail /aws/lambda/FaceAuth-Enrollment --follow --profile dev --region ap-northeast-1
```

Textractが何を返しているか、ログに出力を追加することを検討。

## まとめ

### 現状
- ✅ 画像ファイルは存在し、適切なサイズと形式
- ❌ ローカル環境からTextractに接続できない
- ⚠️ Lambda環境からはTextractに接続できるが、タイムアウト

### 最も可能性が高い問題
**サンプル画像に実際の社員証情報（社員番号、氏名、所属）が含まれていない**

### 推奨アクション
1. 画像内容を確認
2. 必要に応じて新しいテスト画像を作成
3. エンドツーエンドテスト再実行

---
**作成日**: 2026-01-28
**ステータス**: 調査完了、画像確認待ち
