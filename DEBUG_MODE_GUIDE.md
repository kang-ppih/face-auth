# デバッグモード使用ガイド

**作成日:** 2026-01-30  
**バージョン:** 1.0

---

## 概要

Face-Auth IdP システムのフロントエンドにデバッグモードを追加しました。このモードを使用すると、OCR結果（社員番号・氏名）と画像認識の詳細情報をリアルタイムで確認できます。

---

## デバッグモードの有効化

### 方法1: URLパラメータ

URLに `?debug=true` を追加してアクセスします。

**例:**
```
https://d3ecve2syriq5q.cloudfront.net/?debug=true
```

### 方法2: ブラウザのコンソール

ブラウザの開発者ツールを開き、コンソールに以下を入力：

```javascript
window.location.href = window.location.origin + '?debug=true'
```

---

## 表示される情報

### 登録画面（Enrollment）

デバッグモードが有効な場合、以下の情報が表示されます：

#### 1. OCR結果
- **社員番号**: 社員証から抽出された7桁の番号
- **氏名**: 社員証から抽出された氏名（日本語/英語）
- **所属**: 社員証から抽出された部署名（オプション）
- **信頼度**: OCR抽出の信頼度スコア（0-100%）

#### 2. キャプチャ画像
- **社員証画像**: スキャンした社員証の画像
- **顔画像**: 登録した顔写真

#### 3. APIレスポンス
- 完全なAPIレスポンスをJSON形式で表示
- エラー詳細も含む

### ログイン画面（Login）

デバッグモードが有効な場合、以下の情報が表示されます：

#### 1. 認証結果
- **社員番号**: マッチした社員の番号
- **氏名**: マッチした社員の氏名
- **類似度**: 顔マッチングの類似度スコア（0-100%）
- **信頼度**: 顔検出の信頼度スコア（0-100%）
- **失敗回数**: ログイン失敗の回数

#### 2. キャプチャ画像
- **顔画像**: ログインに使用した顔写真

#### 3. APIレスポンス
- 完全なAPIレスポンスをJSON形式で表示
- エラー詳細も含む

---

## 使用例

### 例1: 社員証OCRの検証

1. デバッグモードでアクセス
   ```
   https://d3ecve2syriq5q.cloudfront.net/?debug=true
   ```

2. 「新規登録」を選択

3. 社員証をスキャン

4. デバッグパネルで以下を確認：
   - 社員番号が正しく抽出されているか
   - 氏名が正しく抽出されているか
   - 画像が鮮明に撮影されているか
   - 信頼度スコアが十分か（推奨: 80%以上）

### 例2: 顔認識の検証

1. デバッグモードでアクセス

2. 「ログイン」を選択

3. 顔をカメラに向ける

4. デバッグパネルで以下を確認：
   - 類似度スコアが十分か（推奨: 90%以上）
   - 信頼度スコアが十分か（推奨: 90%以上）
   - 正しい社員にマッチしているか

### 例3: エラーの診断

1. デバッグモードでアクセス

2. 意図的に失敗させる（例: 暗い場所で撮影）

3. デバッグパネルで以下を確認：
   - エラーメッセージの詳細
   - APIレスポンスのエラーコード
   - 失敗した理由（system_reason）

---

## デバッグパネルの見方

### 視覚的な構造

```
┌─────────────────────────────────────┐
│ 🐛 デバッグ情報                      │
├─────────────────────────────────────┤
│ OCR結果 / 認証結果                   │
│ ┌─────────────────────────────────┐ │
│ │ 社員番号: 0285770               │ │
│ │ 氏名: 山田太郎                   │ │
│ │ 所属: 開発部                     │ │
│ │ 信頼度: 95.2%                   │ │
│ └─────────────────────────────────┘ │
├─────────────────────────────────────┤
│ キャプチャ画像                       │
│ ┌──────────┐  ┌──────────┐         │
│ │社員証画像│  │顔画像    │         │
│ │          │  │          │         │
│ └──────────┘  └──────────┘         │
├─────────────────────────────────────┤
│ APIレスポンス                        │
│ ┌─────────────────────────────────┐ │
│ │ {                               │ │
│ │   "success": true,              │ │
│ │   "employeeInfo": {...}         │ │
│ │ }                               │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 色分け

- **グレー背景**: デバッグパネル全体
- **白背景**: 情報ボックス
- **黒背景**: JSONレスポンス（緑色のテキスト）
- **赤色バッジ**: 🐛 DEBUG 表示

---

## トラブルシューティング

### Q1: デバッグパネルが表示されない

**A:** 以下を確認してください：
1. URLに `?debug=true` が含まれているか
2. ページをリロードしたか
3. ブラウザのキャッシュをクリアしたか

### Q2: 画像が表示されない

**A:** 以下を確認してください：
1. カメラの権限が許可されているか
2. 画像のキャプチャが完了しているか
3. ブラウザのコンソールにエラーがないか

### Q3: OCR結果が「未取得」と表示される

**A:** 以下の原因が考えられます：
1. 社員証の画像が不鮮明
2. OCR処理が失敗している
3. APIエラーが発生している
   → APIレスポンスセクションでエラー詳細を確認

### Q4: 信頼度が低い

**A:** 以下を試してください：
1. 明るい場所で撮影
2. カメラを安定させる
3. 社員証を平らに置く
4. 顔を正面から撮影

---

## セキュリティ上の注意

### ⚠️ 重要

1. **本番環境では使用しない**
   - デバッグモードは開発・テスト環境でのみ使用
   - 本番環境では無効化を推奨

2. **機密情報の取り扱い**
   - デバッグ情報には個人情報が含まれる
   - スクリーンショットの共有に注意
   - ブラウザのコンソールログに注意

3. **アクセス制限**
   - デバッグモードのURLは関係者のみに共有
   - 公開ドキュメントには記載しない

---

## 開発者向け情報

### コード構造

**Enrollment.tsx:**
```typescript
// デバッグモードの状態管理
const [debugMode, setDebugMode] = useState<boolean>(false);
const [debugInfo, setDebugInfo] = useState<DebugInfo>({});

// URLパラメータからデバッグモードを検出
useEffect(() => {
  const params = new URLSearchParams(window.location.search);
  const debug = params.get('debug') === 'true';
  setDebugMode(debug);
}, []);

// デバッグ情報の更新
if (debugMode) {
  setDebugInfo(prev => ({
    ...prev,
    employeeId: response.employeeInfo?.employeeId,
    // ...
  }));
}
```

**Login.tsx:**
```typescript
// 同様の構造
```

### CSSクラス

- `.debug-badge` - デバッグバッジ（🐛 DEBUG）
- `.debug-panel` - デバッグパネル全体
- `.debug-section` - セクション（OCR結果、画像など）
- `.debug-info` - 情報ボックス
- `.debug-images` - 画像コンテナ
- `.debug-image` - 画像要素
- `.debug-json` - JSONレスポンス

### カスタマイズ

デバッグパネルの表示内容をカスタマイズする場合：

1. `DebugInfo` インターフェースに新しいフィールドを追加
2. APIレスポンスから情報を抽出
3. デバッグパネルのJSXに表示ロジックを追加

---

## 今後の改善案

### 機能追加

- [ ] デバッグ情報のエクスポート（JSON/CSV）
- [ ] 画像のダウンロード機能
- [ ] リアルタイムログストリーム
- [ ] パフォーマンスメトリクス表示
- [ ] ネットワークリクエストの詳細

### UI改善

- [ ] デバッグパネルの折りたたみ機能
- [ ] ダークモード対応
- [ ] 画像の拡大表示
- [ ] コピー&ペースト機能

---

## 関連ドキュメント

- [OCR Rekognition Migration Report](OCR_REKOGNITION_MIGRATION_REPORT.md)
- [Frontend Implementation Summary](FRONTEND_IMPLEMENTATION_SUMMARY.md)
- [Quick Start Testing Guide](QUICK_START_TESTING_GUIDE.md)

---

## サポート

問題が発生した場合：

1. ブラウザのコンソールログを確認
2. デバッグパネルのAPIレスポンスを確認
3. Lambda関数のCloudWatch Logsを確認
4. 開発チームに連絡

---

**最終更新:** 2026-01-30  
**バージョン:** 1.0  
**作成者:** Kiro AI Assistant
